/*
**   emxTeamDocumentBase.java
**
**   Copyright (c) 1992-2015 Dassault Systemes.
**   All Rights Reserved.
**   This program contains proprietary and trade secret information of
**   MatrixOne, Inc.  Copyright notice is precautionary only
**   and does not evidence any actual or intended publication of such program
**
*/

import matrix.db.*;
import matrix.util.*;
import java.util.*;
import com.matrixone.apps.domain.util.*;
import com.matrixone.apps.domain.*;
import com.matrixone.apps.common.util.*;
import com.matrixone.apps.common.*;


public class ${CLASSNAME} extends ${CLASS:emxCommonDocument}
{
    /**
    * The default constructor.
    * @since Team 10.5
    */
    public ${CLASSNAME} (Context context, String[] args) throws Exception
    {
      super(context, args);
    }

    /**
     * This method is executed before create of document object.
     *
     * @param context the eMatrix <code>Context</code> object
     * @param uploadParamsMap HashMap
     * @param objectId String
     * @return Map containing new Parent Id
     * @throws Exception if the operation fails
     * @since Team 10-5
     */
    public Map preCheckin(Context context, HashMap uploadParamsMap, String objectId) throws Exception
    {

        Map preCheckinMap = new HashMap();
        return preCheckinMap;
    }

    /**
     * This method is executed after create of document object
     *  to handle subscriptions.
     *
     * @param context the eMatrix <code>Context</code> object
     * @param uploadParamsMap HashMap
     * @param objectId String
     * @return void
     * @throws Exception if the operation fails
     * @since Team 10-5
     */
    public void postCheckin(Context context, HashMap uploadParamsMap, StringList objectIds) throws Exception
    {
        String objectAction = (String) uploadParamsMap.get("objectAction");
        String folderId = (String) uploadParamsMap.get("folderId");
        String parentId = (String) uploadParamsMap.get("parentId");
        String folderParentType = "";
        String routeParentId = null;
        String objectId = "";
        String holdId = "";

        String wsRelType = PropertyUtil.getSchemaProperty(context,"relationship_ProjectVaults");
        String folderType = PropertyUtil.getSchemaProperty(context,"type_ProjectVault");
        String wsType = PropertyUtil.getSchemaProperty(context,"type_Project");
        StringBuffer selWSId = new StringBuffer(64);
        selWSId.append("relationship[");
        selWSId.append(wsRelType);
        selWSId.append("].from.id");
        if ((objectAction != null) && (objectAction.indexOf("create") >= 0) || (objectAction.indexOf("Create") >= 0) || "update".equals(objectAction) )
       {
          if ((folderId == null) || 
              ("".equals(folderId)) || 
              ("null".equals(folderId)))
          {
            if ((parentId != null)      &&
                (!"".equals(parentId))  &&
                (!"null".equals(parentId)))
             {
               DomainObject domainObject = DomainObject.newInstance(context);
               domainObject.setId(parentId);
               String rteRelType = PropertyUtil.getSchemaProperty(context,"relationship_ObjectRoute");
               StringBuffer selWSType = new StringBuffer(64);
               selWSType.append("relationship[");
               selWSType.append(wsRelType);
               selWSType.append("].from.type");

               StringBuffer selRteId = new StringBuffer(64);
               selRteId.append("relationship[");
               selRteId.append(rteRelType);
               selRteId.append("].from.id");

               StringList selects = new StringList(4);
               selects.addElement(DomainObject.SELECT_TYPE);
               selects.addElement(selWSType.toString());
               selects.addElement(selWSId.toString());
               selects.addElement(selRteId.toString());

               Map objMap = (Map)domainObject.getInfo(context, selects);
               routeParentId = (String)objMap.get(selRteId.toString());
               String objType = (String)objMap.get(DomainObject.SELECT_TYPE);

               if (objType.equals(folderType))
               {
                   folderId = parentId;
               }
            }
          }
           
          if ((folderId != null)      &&
              (!"".equals(folderId))  &&
              (!"null".equals(folderId)))
          {
              WorkspaceVault folder = (WorkspaceVault)DomainObject.newInstance(context, folderId);
              Workspace workspace = null;
              SubscriptionManager wsSubMgr = null;

              StringList wsSelects = new StringList(1);
              wsSelects.addElement(DomainObject.SELECT_ID);
              Map folderMap = folder.getTopLevelVault(context, wsSelects);
              String topFolderId = (String)folderMap.get(DomainObject.SELECT_ID);
              
              WorkspaceVault topFolder = (WorkspaceVault)DomainObject.newInstance(context, topFolderId);
              String parentVaultId = (String)topFolder.getInfo(context, selWSId.toString());
              DomainObject vault = (DomainObject)DomainObject.newInstance(context, parentVaultId);
              folderParentType = vault.getInfo(context, DomainObject.SELECT_TYPE);
              if (folderParentType.equals(wsType))
              {
                workspace = (Workspace)DomainObject.newInstance(context, parentVaultId);
                wsSubMgr = new SubscriptionManager(workspace);
              }

              Iterator i = objectIds.iterator();
              while (i.hasNext())
              {
                objectId = (String)i.next();
                if ((!"".equals(objectId)) && (!holdId.equals(objectId)))
                {
                   CommonDocument document = (CommonDocument)DomainObject.newInstance(context, objectId);
                   SubscriptionManager subscriptionMgr = new SubscriptionManager(folder);
                   subscriptionMgr.publishEvent(context,
                                                folder.EVENT_CONTENT_ADDED,
                                                objectId);
                 
                   holdId = objectId;
                   if (wsSubMgr != null)
                   {
                     wsSubMgr.publishEvent(context,
                                           workspace.EVENT_FOLDER_CONTENT_MODIFIED,
                                           objectId);
                   }
                }
             }
          }
          if (routeParentId != null)
          {
            holdId = "";
            Iterator i = objectIds.iterator();
            while (i.hasNext())
            {
               objectId = (String)i.next();
               if ((!"".equals(objectId)) && (!holdId.equals(objectId)))
               {
                  Route route = (Route)DomainObject.newInstance(context, routeParentId);
                  SubscriptionManager rteSubMgr = new SubscriptionManager(route);
                  rteSubMgr.publishEvent(context,
                                         route.EVENT_CONTENT_ADDED,
                                         objectId);

                  holdId = objectId;
               }
            }
          }
       }
       else if(objectAction != null && "update".equals(objectAction))
       {
          Iterator i = objectIds.iterator();
          while (i.hasNext())
          {
             objectId = (String)i.next();
             if ((!"".equals(objectId)) && (!holdId.equals(objectId)))
             {
                CommonDocument document = (CommonDocument)DomainObject.newInstance(context, objectId);
                String docName = document.getInfo(context, DomainObject.SELECT_NAME);
                SubscriptionManager docSubMgr = new SubscriptionManager(document);
                docSubMgr.publishEvent(context,
                                       document.EVENT_FILE_CHECKED_IN,
                                       objectId);
                holdId = objectId;
             }
          }
       }
    }
}

